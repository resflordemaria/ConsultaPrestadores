<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prestadores Flor de Maria — Debug</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;padding:18px;background:#f6f7f8;color:#222}
    h1{margin:0 0 8px}
    #status{margin-top:8px;font-style:italic;color:#444}
    #debug{white-space:pre-wrap;background:#111;color:#dcdcdc;padding:12px;border-radius:6px;margin-top:12px;max-height:300px;overflow:auto;font-family:monospace;font-size:13px}
    .categoria-bloco{margin-top:20px}
    .categoria-titulo{background:#e9eef3;padding:8px;border-radius:6px;font-weight:700}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid #cfcfcf;padding:8px;text-align:left}
    th{background:#f2f5f8}
    select{padding:6px}
    #resultados{margin-top:14px}
    .error{color:#a00}
  </style>
</head>
<body>
  <h1>Prestadores Flor de Maria</h1>
  <label for="categoria">Filtrar por categoria:</label>
  <select id="categoria" onchange="filtrarDados()">
    <option value="">-- Todas as categorias --</option>
  </select>

  <div id="status">Carregando dados...</div>

  <div id="resultados"></div>

  <h3>Debug (detalhes)</h3>
  <div id="debug">Executando... aguarde.</div>

  <!-- PapaParse -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

  <script>
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vTr4FxiY5aB2DdJ_bQfxg-ZRwud8xTsK_W2M8a2lnk6xtRd1854GH7nmRQM2tiWICBqIi6za3eKxDuZ/pub?gid=0&single=true&output=csv';

    const statusDiv = document.getElementById('status');
    const debugDiv = document.getElementById('debug');
    const resultadosDiv = document.getElementById('resultados');
    const selectEl = document.getElementById('categoria');

    let dados = [];
    let categoriasOrdenadas = [];

    function logDebug(text){
      console.log(text);
      debugDiv.textContent += text + "\n";
    }

    function clearDebug(){ debugDiv.textContent = ''; }

    // fetch com timeout
    function fetchWithTimeout(url, ms = 10000) {
      const controller = new AbortController();
      const id = setTimeout(() => controller.abort(), ms);
      return fetch(url, { signal: controller.signal }).finally(() => clearTimeout(id));
    }

    // detecta cabeçalhos (case-insensitive)
    function detectarCampos(headers) {
      const map = {};
      (headers || []).forEach(h => {
        const k = (h||'').toString().trim().toLowerCase();
        if (k.includes('nome') && !map.nome) map.nome = h;
        if ((k.includes('tel') || k.includes('fone') || k.includes('cel') || k.includes('telefone')) && !map.telefone) map.telefone = h;
        if (k.includes('categoria') && !map.categoria) map.categoria = h;
      });
      return map;
    }

    function normalizarNumeroParaZap(t) {
      if (!t) return '';
      let d = String(t).replace(/\D/g,'');
      if (!d) return '';
      if (d.startsWith('55')) return d;
      if (d.length === 10 || d.length === 11) return '55' + d;
      if (d.length === 8 || d.length === 9) return '5582' + d; // DDD 82 por padrão
      return '';
    }

    async function carregarCategoriasEDados(){
      clearDebug();
      statusDiv.textContent = 'Carregando dados...';
      logDebug('Iniciando fetch do CSV: ' + CSV_URL);
      try {
        const res = await fetchWithTimeout(CSV_URL, 10000);
        logDebug('Fetch finalizado. status: ' + res.status + ' ' + res.statusText);
        if (!res.ok) {
          statusDiv.textContent = 'Erro ao buscar CSV: ' + res.status + ' ' + res.statusText;
          logDebug('Resposta HTTP não OK; corpo abaixo (primeiros 1000 chars):');
          const txt = await res.text().catch(()=>'<sem corpo>');
          logDebug(txt.slice(0,1000));
          return;
        }

        const csvText = await res.text();
        logDebug('CSV recebido — tamanho (bytes): ' + csvText.length);
        logDebug('--- Início do CSV (até 1000 chars) ---\\n' + csvText.slice(0,1000) + '\\n--- Fim do trecho ---');

        if (typeof Papa === 'undefined') {
          statusDiv.textContent = 'Erro: PapaParse não carregou.';
          logDebug('PapaParse não disponível (window.Papa undefined).');
          return;
        }

        const parsed = Papa.parse(csvText, { header: true, skipEmptyLines: true });
        logDebug('PapaParse: fields = ' + JSON.stringify(parsed.meta && parsed.meta.fields));
        logDebug('PapaParse: rows = ' + (parsed.data ? parsed.data.length : 0));
        if (parsed.errors && parsed.errors.length) {
          logDebug('PapaParse - erros: ' + JSON.stringify(parsed.errors));
        }

        if (!parsed.meta || !parsed.meta.fields || parsed.meta.fields.length === 0) {
          statusDiv.textContent = 'CSV sem cabeçalho detectável. Verifique publicação/headers.';
          logDebug('Nenhum header detectado em parsed.meta.fields.');
          return;
        }

        const campos = detectarCampos(parsed.meta.fields);
        logDebug('Campos detectados: ' + JSON.stringify(campos));

        if (!campos.nome || !campos.categoria || !campos.telefone) {
          statusDiv.textContent = 'Cabeçalhos esperados não encontrados. Veja debug para detalhes.';
          logDebug('Headers reais: ' + JSON.stringify(parsed.meta.fields));
          logDebug('Procure por colunas contendo (nome / categoria / tel|fone|cel|telefone).');
          return;
        }

        // normaliza dados
        dados = (parsed.data || []).map(r => ({
          nome: (r[campos.nome]||'').toString().trim(),
          telefone: (r[campos.telefone]||'').toString().trim(),
          categoria: (r[campos.categoria]||'').toString().trim()
        })).filter(x => x.nome || x.telefone || x.categoria);

        logDebug('Linhas normalizadas: ' + dados.length);

        // categorias
        const setCats = new Set(dados.map(d => d.categoria).filter(Boolean));
        categoriasOrdenadas = Array.from(setCats).sort((a,b)=> a.localeCompare(b,'pt-BR',{sensitivity:'base'}));
        logDebug('Categorias detectadas: ' + JSON.stringify(categoriasOrdenadas));

        // preencher select
        selectEl.innerHTML = '<option value="">-- Todas as categorias --</option>';
        categoriasOrdenadas.forEach(c=> {
          const opt = document.createElement('option'); opt.value = c; opt.textContent = c; selectEl.appendChild(opt);
        });

        // render inicial
        if (dados.length === 0) {
          statusDiv.textContent = 'Nenhum dado útil encontrado no CSV.';
          logDebug('Nenhuma linha significativa após normalização.');
        } else {
          statusDiv.textContent = '';
          renderTodasCategorias();
        }
      } catch (err) {
        if (err && err.name === 'AbortError') {
          statusDiv.textContent = 'Timeout ao buscar CSV (demorou demais).';
          logDebug('Erro: Timeout (AbortError).');
        } else {
          statusDiv.textContent = 'Erro ao carregar dados (veja console/debug).';
          logDebug('Erro capturado: ' + (err && (err.message||String(err))));
          console.error(err);
        }
      }
    }

    function filtrarDados(){
      const cat = selectEl.value;
      if (!cat) renderTodasCategorias();
      else renderUmaCategoria(cat);
    }

    function renderTodasCategorias(){
      resultadosDiv.innerHTML = '';
      if (categoriasOrdenadas.length === 0) {
        resultadosDiv.innerHTML = '<div class="error">Nenhuma categoria encontrada.</div>';
        return;
      }
      categoriasOrdenadas.forEach(cat => {
        const lista = dados.filter(d => d.categoria === cat);
        if (lista.length) resultadosDiv.appendChild(criarBlocoCategoria(cat, lista));
      });
    }

    function renderUmaCategoria(cat){
      resultadosDiv.innerHTML = '';
      const lista = dados.filter(d => d.categoria === cat);
      if (!lista.length) {
        resultadosDiv.innerHTML = '<div class="error">Nenhum resultado para esta categoria.</div>';
        return;
      }
      resultadosDiv.appendChild(criarBlocoCategoria(cat, lista));
    }

    function criarBlocoCategoria(nomeCategoria, lista){
      const bloco = document.createElement('div'); bloco.className = 'categoria-bloco';
      const titulo = document.createElement('div'); titulo.className = 'categoria-titulo'; titulo.textContent = nomeCategoria || 'Sem categoria';
      bloco.appendChild(titulo);

      const tabela = document.createElement('table');
      tabela.innerHTML = `<thead><tr><th>Nome</th><th>Telefone</th><th>WhatsApp</th></tr></thead><tbody></tbody>`;
      const tbody = tabela.querySelector('tbody');

      lista.sort((a,b) => a.nome.localeCompare(b.nome, 'pt-BR', {sensitivity:'base'}));
      lista.forEach(item => {
        const numeroZap = normalizarNumeroParaZap(item.telefone);
        const linkZap = numeroZap ? `<a href="https://wa.me/${numeroZap}" target="_blank" rel="noopener">Falar no WhatsApp</a>` : '';
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${item.nome||''}</td><td>${item.telefone||''}</td><td>${linkZap}</td>`;
        tbody.appendChild(tr);
      });

      bloco.appendChild(tabela);
      return bloco;
    }

    // inicia
    carregarCategoriasEDados();
  </script>
</body>
</html>
